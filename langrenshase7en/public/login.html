<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‹¼äººæ€ - ç™»å½•/æ³¨å†Œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-size: 28px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus {
      border-color: #667eea;
      outline: none;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      width: 100%;
      margin-top: 10px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    .tab {
      flex: 1;
      padding: 10px 20px;
      cursor: pointer;
      color: #666;
      font-weight: bold;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    .tab:hover {
      color: #667eea;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 2px solid #bee5eb;
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸº ç‹¼äººæ€</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="showTab('login')">ç™»å½•</div>
      <div class="tab" onclick="showTab('register')">æ³¨å†Œ</div>
    </div>
    
    <div id="loginTab" class="tab-content active">
      <div class="form-group">
        <label for="loginUsername">ç”¨æˆ·åï¼š</label>
        <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
      </div>
      <div class="form-group">
        <label for="loginPassword">å¯†ç ï¼š</label>
        <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
      </div>
      <button id="loginBtn" onclick="handleLogin()">ç™»å½•</button>
      <div id="loginResult"></div>
    </div>
    
    <div id="registerTab" class="tab-content">
      <div class="form-group">
        <label for="regUsername">ç”¨æˆ·åï¼š</label>
        <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
      </div>
      <div class="form-group">
        <label for="regPassword">å¯†ç ï¼š</label>
        <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
      </div>
      <div class="form-group">
        <label for="regEmail">é‚®ç®±ï¼š</label>
        <input type="email" id="regEmail" placeholder="è¯·è¾“å…¥é‚®ç®±">
      </div>
      <button id="regBtn" onclick="handleRegister()">æ³¨å†Œ</button>
      <div id="regResult"></div>
    </div>
  </div>

  <script type="module">
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    async function handleLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const resultDiv = document.getElementById('loginResult');
      const loginBtn = document.getElementById('loginBtn');
      
      if (!username || !password) {
        showResult('loginResult', 'error', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
      }
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'ç™»å½•ä¸­...';
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });
        
        const result = await response.json();
        
        if (result.success) {
          showResult('loginResult', 'success', `ç™»å½•æˆåŠŸï¼<br>æ¬¢è¿å›æ¥ï¼Œ${result.user.username}ï¼<br><a href="/">è¿›å…¥æ¸¸æˆå¤§å…</a>`);
          localStorage.setItem('user', JSON.stringify(result.user));
        } else {
          showResult('loginResult', 'error', result.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
        }
      } catch (error) {
        showResult('loginResult', 'error', `ç™»å½•å‡ºé”™ï¼š${error.message}`);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'ç™»å½•';
      }
    }

    async function handleRegister() {
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value;
      const email = document.getElementById('regEmail').value.trim();
      const resultDiv = document.getElementById('regResult');
      const regBtn = document.getElementById('regBtn');
      
      if (!username || !password || !email) {
        showResult('regResult', 'error', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
        return;
      }
      
      regBtn.disabled = true;
      regBtn.textContent = 'æ³¨å†Œä¸­...';
      
      try {
        const passwordHash = await hashPassword(password);
        
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, passwordHash, email }),
        });
        
        const result = await response.json();
        
        if (result.success) {
          showResult('regResult', 'success', `æ³¨å†ŒæˆåŠŸï¼<br>ç”¨æˆ·åï¼š${result.user.username}<br>é‚®ç®±ï¼š${result.user.email}<br><a href="/">å»ç™»å½•</a>`);
        } else {
          showResult('regResult', 'error', result.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } catch (error) {
        showResult('regResult', 'error', `æ³¨å†Œå‡ºé”™ï¼š${error.message}`);
      } finally {
        regBtn.disabled = false;
        regBtn.textContent = 'æ³¨å†Œ';
      }
    }

    function showResult(divId, type, message) {
      const div = document.getElementById(divId);
      div.className = type;
      div.innerHTML = message;
    }

    function showTab(tabName) {
      const loginTab = document.getElementById('loginTab');
      const registerTab = document.getElementById('registerTab');
      const tabs = document.querySelectorAll('.tab');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      
      if (tabName === 'login') {
        loginTab.classList.add('active');
        tabs[0].classList.add('active');
      } else {
        registerTab.classList.add('active');
        tabs[1].classList.add('active');
      }
    }

    window.onload = function() {
      const savedUser = localStorage.getItem('user');
      if (savedUser) {
        const user = JSON.parse(savedUser);
        showResult('loginResult', 'info', `æ¬¢è¿å›æ¥ï¼Œ${user.username}ï¼<br><a href="/">è¿›å…¥æ¸¸æˆå¤§å…</a>`);
      }
    };
  </script>
</body>
</html>
