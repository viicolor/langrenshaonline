# 狼人杀项目完善路线图：后台管理 + 游戏端

基于当前代码与 `backend-admin-development-plan.md` 整理的可执行优先级建议。

---

## 一、当前状态速览

| 模块 | 已有能力 | 缺口/待统一 |
|------|----------|-------------|
| **后台** | 板子 / 卡牌 / 技能 / 全局配置 / 流程 / AI 配置的增删改查；config_log、env_type 已上库；**管理员鉴权（AdminGuard）**；**配置日志列表**；**全局配置 env_type 筛选与展示**；**板子保存时同步 board_roles** | 配置校验与提示优化；列表分页、加载态统一 |
| **游戏端** | 同上；**游戏房间内阶段名称与倒计时 UI**；**对局阶段持久化**（game_records.current_phase/current_round/phase_ends_at）；**多端订阅 game_records 同步**；**倒计时结束自动推进阶段**（advanceToNextPhase 幂等） | 胜负结算与结束对局、技能释放与死亡遗言 |
| **数据** | boards 有 board_name、character_config；board_roles 含 card_id；发身份、技能解析、胜负、流程均从同一套配置来 | Supabase types 与迁移保持同步 |

### 已完成（截至当前）

- **后台**：管理员鉴权、配置日志列表、全局配置 env_type、板子保存同步 board_roles、**BoardForm 数据一致性校验**（角色总数=玩家数量 + 实时提示与错误展示）、列表加载态已有  
- **游戏端**：发身份数据源统一、阵营胜负、流程阶段配置、技能 effect_params 校验、RuleEngine 阶段时长可配置、gameEngine 阶段开始返回配置时长、大厅与房间体验、游戏房间内阶段名称与倒计时 UI、**对局阶段持久化与多端同步**（game_records 阶段字段 + 订阅 + 倒计时结束自动推进）

---

## 二、后台管理完善（建议顺序）

### 1. 管理员鉴权与登录（高）✅ 已完成

- **目标**：仅管理员可访问 `/admin`，未登录或非管理员跳转首页或登录页。
- **做法**：
  - 用 Supabase Auth 或现有 `users` 表做登录；在 `users` 上区分管理员（如 `is_admin` 或 role）。
  - 在路由层（如 React Router 的 loader/或 AdminDashboard 内）校验：已登录 + 管理员，否则 `navigate('/')` 或 `/login`。
- **参考**：现有 `authService`、`users` 表及 RLS 策略。

### 2. 配置生效记录查看（中）✅ 已完成

- **目标**：在后台能查看「谁在何时改了哪条配置」。
- **做法**：在 AdminDashboard 增加「配置日志」入口，列表展示 `config_log`（操作人、时间、对象 id、摘要），可选按操作类型/表名筛选。

### 3. 按环境区分配置（中）✅ 已完成

- **目标**：全局配置等支持按 env_type（如 test/prod）展示或切换，避免误改生产。
- **做法**：在全局配置列表/表单中增加 env_type 筛选与展示；编辑时带 env_type 写入，必要时按环境做只读/提示。

### 4. 数据一致性校验（中）✅ 已完成

- **目标**：板子用的卡牌来自卡牌表，删除卡牌前已校验板子引用；可再加强「板子总人数 = 各角色人数之和」等校验。
- **做法**：BoardForm 提交时已校验角色总数 = 玩家数量；角色配置区展示「角色总数 / 玩家数量」实时提示与错误信息；卡牌删除前（已有 `checkCardUsedByBoards`）关联板子引用。

### 5. 后台体验与健壮性（低）

- 列表分页、加载态、错误提示统一；
- 技能/全局配置的 JSON 编辑：可做简单 schema 校验或表单化编辑，减少配置错误。

---

## 三、游戏端完善（建议顺序）

### 1. 发身份数据源统一（高）✅ 已完成

- **目标**：`assignRoles` 使用的「板子角色」与后台配置一致，且不依赖未同步的字段。
- **现状**：`gameEngine.assignRoles` 用 `getBoardRoles(boardId)` 取 `board_roles`，并按 `br.card_id` 找 `config.cards`；若表中只有 `role_type` 则需兼容或迁移。
- **做法**：
  - **方案 A**：确认远程 `board_roles` 是否已有 `card_id`；若有，确保 types 与 Supabase 一致，并让后台「保存板子」时同步写 `board_roles`（card_id + count），不再仅写 `character_config`。
  - **方案 B**：若暂时只有 `character_config`，则游戏端增加「从 boards.character_config 解析角色」的路径，与 `board_roles` 二选一或优先其一，保证一种数据源为主。

### 2. 游戏引擎用「配置表」驱动（高）✅ 大部分已完成

- **目标**：技能效果、胜负判定、流程阶段都从 `skills`、`global_configs`、`processes` 读，便于后台改配置即生效。
- **做法**：
  - **技能**：`NightActionResolver` 等根据角色对应的 `skill_id` 读 `skills.effect_params`，执行目标选择、次数、冷却等。✅
  - **胜负**：`WinConditionChecker` 用 `cards.camp`（或从配置解析的阵营）判断狼人/好人/中立胜负条件。✅
  - **流程**：按 `processes.phase_config` 驱动夜晚/白天/投票顺序与时长，替代硬编码阶段。✅（GameStateMachine + gameConfig.getPhaseConfig/getPhaseDuration；RuleEngine 支持可选阶段时长提供者；gameEngine 开始阶段返回配置时长）

### 3. 对局流程与状态同步（高）✅ 已完成

- **目标**：从「发身份」到「夜晚/白天/投票/结算」完整跑通，多端状态一致。
- **做法**：
  - 游戏状态存库（game_records 增加 current_phase/current_round/phase_started_at/phase_ends_at）；阶段切换时持久化并发布 Realtime。✅
  - 房间内所有玩家订阅同一 game_record（gameService.subscribeToGameRecord），GameRoom 拉取当前对局并同步阶段/倒计时；倒计时结束自动 advanceToNextPhase（服务端幂等）。✅

### 4. 游戏内体验（中）进行中

- **目标**：可玩、可懂、可复盘。
- **做法**：
  - 夜晚/白天/投票阶段有明确倒计时与阶段名称（来自 processes 配置）。✅ 游戏房间内已展示「第X夜/天/投票」与流程配置时长倒计时（M:SS）。
  - 技能释放：目标选择、确认、结果反馈（如查验结果仅自己可见）。
  - 死亡与遗言：按 global_configs 的死亡规则决定是否可发言/亮身份。
  - 复盘：从 game_records + game_actions 或日志回放关键节点（可选）。

### 5. 大厅与房间体验（中）✅ 已完成

- **目标**：列表稳定、进房顺畅、准备/开始逻辑清晰。
- **做法**：
  - 大厅房间列表用 Supabase Realtime 或短轮询更新状态；显示板子名、人数、是否已开局。✅
  - 房间内：显示当前板子、人数、准备状态；仅房主可开始游戏；开始后调用 `createGameRecord` + `assignRoles`，再跳转或切换到游戏界面。✅

---

## 四、数据与表结构（按需配合）

- **board_roles**：若尚未有 `card_id`，建议加迁移 `ADD COLUMN card_id UUID REFERENCES cards(id)`，并让后台保存板子时写入；游戏端发身份统一用 `board_roles.card_id` + `cards`。
- **boards**：若已用 `character_config` 存角色列表，可保留为冗余或逐步迁移到仅用 `board_roles`，避免两套逻辑长期并存。
- **Supabase types**：执行迁移后运行 `npx supabase gen types typescript --linked > src/integrations/supabase/types.ts`，保证类型与库一致。

---

## 五、建议执行顺序（按周）

| 周 | 后台 | 游戏端 |
|----|------|--------|
| 1 | 管理员鉴权 + 登录；配置日志列表 | 发身份数据源统一（board_roles/character_config 二选一或兼容） |
| 2 | env_type 在全局配置中的使用；板子保存时同步 board_roles（若已加 card_id） | 技能解析用 skills 表；胜负用 camp |
| 3 | 配置校验与提示优化 | 流程用 processes；阶段/倒计时/状态同步 |
| 4 | 体验与健壮性 | 对局体验、复盘、大厅/房间体验 |

---

## 六、文档与代码参考

- 表结构与开发计划：`docs/backend-admin-development-plan.md`
- 远程库与迁移：`docs/Supabase远程数据库首次配置.md`
- 发身份逻辑：`src/services/gameEngine.ts`（`assignRoles`）
- 配置加载：`src/services/gameConfig.ts`（`getGameConfig`、`getBoardRoles`、`getPhaseConfig`、`getPhaseDuration`）
- 阶段时长配置化：`src/services/RuleEngine.ts`（`setPhaseDurationGetter`）、`src/services/gameEngine.ts`（`startNightPhase`/`startDayPhase`/`startVotingPhase` 返回 `durationSeconds`）
- 后台板子表单（character_config 结构）：`src/components/admin/BoardForm.tsx`

按上述顺序推进，可先打通「后台改板子/卡牌/技能 → 游戏端完整一局用同一套配置」，再迭代体验与复盘等功能。
