# 狼人杀完整游戏流程开发参考（基于 v1.1 文档）

本文档提炼自《狼人杀完整游戏流程文档（含全角色入夜行动顺序）v1.1》，供开发时对齐规则与实现游戏流程、阶段、时长和特殊情况。

---

## 一、核心原则

- **夜晚角色行动总顺序**（固定，特殊板子仅插入对应角色，不打乱顺序）：
  - **前置特殊角色**（仅首夜/特定板子）→ **守护/防护类** → **狼人阵营击杀/魅惑类** → **查验/信息类** → **功能/技能类** → **收尾确认类**
- **技能冲突**：专属技能 > 基础技能；同优先级按夜晚行动顺序判定。
- **狼刀在先**：白天公布出局后，若好人/狼人同时满足胜利条件，判狼人获胜。

---

## 二、开局准备阶段

| 项 | 说明 |
|----|------|
| 人数与板子 | 根据人数选板子（如 10 人速推、12 人标准），明确屠边/警长等规则 |
| 身份发放 | 按板子洗牌发牌，玩家查看后闭眼确认，禁止泄露 |
| 盗贼板子 | 多 2 张平民牌，首夜盗贼可选择与额外牌交换身份 |
| 第三方 | 丘比特、盗宝大师等单独分配，避免阵营失衡 |

**法官话术**：*「各位玩家请确认身份牌，身份确认完毕后请闭眼，狼人杀游戏正式开始。」*

**线上时长**：
- 身份确认：15 秒内点击「确认闭眼」，超时视为自动确认
- 房间等待：默认 3 分钟（可配置），人数齐且准备后 30 秒强制开始

---

## 三、夜晚阶段：全角色行动顺序与时长

### 3.1 通用夜晚行动总顺序（六步）

1. **前置特殊角色**（仅对应板子/首夜）
2. **守护/防护类**
3. **狼人阵营击杀/魅惑类**
4. **查验/信息类**
5. **功能/技能类**
6. **收尾确认类**

### 3.2 分步角色与操作时长（秒）

| 步骤 | 角色 | 板子/触发 | 操作时长 | 说明 |
|------|------|-----------|----------|------|
| **第一步** | 盗贼 | 盗贼板子，仅首夜 | 15 | 可交换额外 2 张牌身份，超时维持原身份 |
| | 丘比特 | 爱神板子，仅首夜 | 20 | 选 2 人结为情侣，超时系统随机 2 人 |
| | 野孩子 | 野孩子板子，仅首夜 | 15 | 选 1 人崇拜者，超时随机 1 人 |
| | 盗宝大师 | 失踪的宝物 | 15/晚 | 盗取一人技能，该玩家当晚无法使用 |
| | 禁锢之影 | 月影传说 | 15/晚 | 禁锢一名好人，当晚技能失效 |
| | 织梦人 | 黑狼王与织梦人 | 15/晚 | 选一人梦游，免疫夜间伤害 |
| **第二步** | 守卫 | 基础/进阶 | 20 | 守护一人，不可连续两晚同一人；超时无守护 |
| | 企鹅 | 疯狂动物园 | 15 | 冰冻一人，当晚技能失效 |
| **第三步** | 狼人（含黑/白狼王） | 所有狼人板子 | 30 | 团队统一刀人，超时/不一致→平安夜；多数决 |
| | 狼美人 | 狼美人板子 | 15 | 魅惑一人，不可连续两晚同一人；死后被魅惑者殉情 |
| | 憎恶猎人 | 狼狼大逃亡 | 15 | 袭击一人 |
| **第四步** | 预言家 | 基础/进阶 | 15 | 查验一人，好人向上/狼人向下 |
| | 通灵师 | 机械狼/通灵师 | 15 | 查验具体身份 |
| | 熊 | 疯狂动物园 | 无 | 系统自动看相邻是否有狼，是否咆哮 |
| | 机械狼 | 机械狼板子 | 15+15 | 先学习一人技能（仅一次），后有技能时再触发 |
| | 石像鬼 | 石像鬼板子 | 15 | 查验具体身份；与狼互不知；狼全出局后获得刀人 |
| **第五步** | 女巫 | 基础/进阶/娱乐 | 25 | 被告知刀人，可用解药或毒药其一；首夜自救可配置；超时双药保留 |
| | 月夜祭司 | 月影传说 | 无 | 夜间被击杀则次日狼人不能刀人 |
| | 机械狼技能 | 机械狼板子 | 15 | 按学习身份使用技能（如女巫毒、守卫守） |
| **第六步** | 猎人 | 含猎人板子 | 10 | 确认开枪状态（被毒不可开） |
| | 守夜人 | 石像鬼守夜人 | 10 | 接收上一白天被放逐者身份 |
| | 小女孩 | 小女孩板子 | 随狼人 | 狼人行动时可偷看，被指认则立即死亡、当晚不刀人 |

### 3.3 特殊板子夜晚顺序说明

- **爱神**：首夜第一步加丘比特，其余不变。
- **狼美人**：第三步狼人刀人后加狼美人魅惑。
- **疯狂动物园**：第二步加企鹅，第四步加熊。
- **石像鬼**：第四步末尾石像鬼，第六步收尾加守夜人。
- **机械狼**：第四步学习技能，第五步触发技能，两段各 15 秒。

### 3.4 夜晚特殊情况（线上）

- 狼人刀人超时/意见不一：30 秒后无统一目标→平安夜；有部分一致则多数决。
- 角色离线：视为放弃技能，按超时规则处理；狼人离线仅少一票，其余狼照常刀人。
- 奶穿：守卫守护 + 女巫解药同一人→该玩家死亡，死讯标注「奶穿死亡」。

---

## 四、白天阶段：流程与时长

### 4.1 白天总流程

**警长竞选**（仅第一天，且开启警长时）→ **死讯公布** → **遗言** → **轮流发言** → **公投** → **出局结算** → 循环至「天黑请闭眼」。

狼人自爆可立即终止当前白天流程，进入下一夜。

### 4.2 警长竞选（仅第一天）

| 环节 | 时长 | 说明 |
|------|------|------|
| 上警报名 | 10 秒 | 超时无法上警，自动警下 |
| 警上发言 | 60 秒/人 | 可退水，退水后无被选权 |
| 警下投票 | 15 秒 | 超时视为放弃 |
| 平票 | 最多 2 次 PK 再投 | 仍平票则警徽流失，本局无警长 |
| 自爆 | - | 警上狼自爆→竞选终止，警徽流失，直接下一夜 |

警长：1.5 票、最后发言（归票）、可移交警徽；死亡后可移交或流失。

### 4.3 死讯与遗言

- 话术：*「昨夜死亡的玩家是 X 号、X 号」* 或 *「昨夜是平安夜」*。
- 遗言规则：首夜夜间死亡有遗言，之后夜间死亡无遗言；白天出局均有遗言。
- 遗言时长：普通 60 秒、警长 150 秒、狼自爆 30 秒；超时自动截断进入下一流程。
- 特殊：情侣殉情、猎人开枪（被刀/公投可开枪，被毒不可）、炸弹师出局带走投票者（无遗言）。

### 4.4 轮流发言

| 项 | 说明 |
|----|------|
| 顺序 | 有警长由警长指定警左/警右，警长最后；无警长系统随机（如死左/死右） |
| 时长 | 120 秒/人，警长 150 秒；超时自动切下一位 |
| 自爆 | 狼自爆立即终止发言，30 秒遗言后直接下一夜 |

### 4.5 公投

| 项 | 说明 |
|----|------|
| 投票时长 | 20 秒，超时视为放弃 |
| 警长 | 1.5 票，系统自动计算 |
| 平票 | 最多 2 次 PK：每人 30 秒发言→15 秒投票；二次仍平票→平安日，无人出局，直接进入下一夜 |
| 出局 | 得票最多者出局，遗言后离场 |

### 4.6 白天特殊情况

- 猎人开枪：出局后 10 秒内选择击杀目标，超时视为放弃开枪。
- 玩家离线：视为放弃发言/投票；警长离线死亡则警徽流失（不可移交）。
- 狼自爆：立即终止流程，30 秒遗言后下一夜，未完成发言/投票作废。

---

## 五、胜负判定

### 5.1 通用

- **好人**：淘汰所有狼人及第三方（若有）；屠边局为淘汰所有狼人或所有神或所有民。
- **狼人**：屠城为淘汰除己方外所有人；屠边为淘汰所有神或所有民；**狼刀在先**（同日同时满足则狼人胜）。

### 5.2 第三方（按板子）

- **丘比特**：情侣双好→好人阵营；双狼→狼阵营；一好一狼→第三方可与情侣一起获胜（淘汰其余所有人）。
- **盗宝大师**：好人阵营与狼人阵营存活均 ≤1 时，盗宝大师胜。
- **野孩子**：崇拜者出局前跟好人，出局后跟狼，随当前归属阵营胜。
- **狼狼大逃亡**：好人淘汰所有憎恶猎人；或憎恶猎人淘汰所有好人。

---

## 六、与当前实现的对照（开发清单）

### 6.1 已有基础

- `GamePhase`: `waiting | night | day | voting | finished`
- 阶段持久化：`game_records.current_phase`、`phase_ends_at`、`current_round`
- 夜晚/白天/投票的 `startNightPhase`、`startDayPhase`、`startVotingPhase` 与 `advanceToNextPhase`
- 夜晚行动收集与解析（如 `game_actions`、`NightActionResolver`）
- 流程配置表 `processes.phase_config`（当前为简化版 night→day）

### 6.2 待实现/强化的流程（按 v1.1）

| 类别 | 项 | 说明 |
|------|----|------|
| **夜晚** | 按角色顺序的子阶段 | 将「夜晚」拆为多步：前置特殊→守卫→狼人→预言家→女巫→猎人等，每步独立时长与 UI |
| | 各角色操作时长 | 守卫 20s、狼人 30s、预言家 15s、女巫 25s、猎人 10s 等（可配置） |
| | 板子差异 | 爱神首夜丘比特、狼美人魅惑、石像鬼/守夜人、机械狼学习+触发、熊自动判定等 |
| | 奶穿与技能优先级 | 守卫+女巫同目标→奶穿；狼美人魅惑 > 狼刀 > 守卫 > 女巫 |
| **白天** | 警长竞选 | 仅第一天：上警 10s→警上发言 60s/人→警下投票 15s，平票最多 2 次 PK |
| | 死讯与遗言 | 首夜刀死有遗言、之后夜间刀死无遗言；遗言时长 60/150/30（普通/警长/自爆） |
| | 发言顺序 | 警长指定警左/警右，警长最后；无警长按死左/死右 |
| | 发言时长 | 120s/人，警长 150s；超时自动下一位 |
| | 自爆 | 随时自爆→终止白天，30s 遗言后直接下一夜 |
| **公投** | 平票 PK | 最多 2 次：30s 发言 + 15s 投票；二次平票→平安日 |
| | 猎人开枪 | 出局后 10s 内选目标，被毒不可开枪 |
| **开局** | 身份确认 15s | 超时视为确认并进入夜晚 |
| | 盗贼/丘比特首夜 | 若有板子，首夜前置步骤与时长 |
| **胜负** | 狼刀在先 | 同日同时满足条件时判狼人胜 |
| | 第三方胜利 | 丘比特/盗宝大师/野孩子/狼狼大逃亡等条件 |

### 6.3 建议实现顺序与当前进度

| 顺序 | 项 | 状态 | 说明 |
|------|----|------|------|
| 1 | **夜晚子阶段与时长** | ✅ 已实现 | `game_records.night_step`、`getNightSteps()`、按步倒计时与技能可用性；流程可配 `phase_config.night_steps` 或使用默认守卫→狼人→预言家→女巫→猎人 |
| 2 | **白天子阶段** | 待实现 | 警长竞选（仅第一天）→ 死讯 → 遗言 → 发言 → 公投，每步独立阶段与时长 |
| 3 | **遗言与死讯** | 待实现 | 按首夜/非首夜、白天出局区分是否有遗言及时长 |
| 4 | **平票 PK 与平安日** | 部分 | 当前：平票即无人出局并发「平票，无人出局（平安日），直接进入下一夜」；完整 PK（最多 2 次 30s 发言+15s 投票）需 `vote_pk_round` 与 `vote_round` 在 actions 中区分 |
| 5 | **自爆与猎人开枪** | 待实现 | 自爆终止白天；猎人 10s 内选目标 |
| 6 | **狼刀在先与第三方** | 待实现 | 在 `WinConditionChecker` 中实现 |

---

---

## 七、与后台「自由配置板子 + 牌库」的兼容说明

**结论：不冲突。** v1.1 是**规则与顺序的规范**，后台的板子、牌库、流程都是**可配置数据**，只要用「流程 + 技能顺序」驱动夜晚，即可同时满足 v1.1 与自由配置。

### 7.1 当前数据关系（简要）

| 配置项 | 作用 | 自由配置 |
|--------|------|----------|
| **板子 (boards)** | 一局用多少人、用哪套流程等 | ✅ 后台可增删改板子 |
| **板子角色 (board_roles)** | 某板子包含哪些牌、各几张 | ✅ 自由选 card_id + count |
| **牌库 (cards)** | 角色名称、阵营、关联技能 | ✅ 后台可增删改卡牌 |
| **技能 (skills)** | 技能码、触发阶段、目标/效果参数 | ✅ 后台可增删改技能 |
| **流程 (processes)** | 阶段顺序、每阶段包含哪些 action（如夜晚各步） | ✅ 后台可增删改流程，phase_config 可编辑 |

发身份时：按**板子**选中的 **board_roles** 发**牌库**里的**卡牌**；卡牌绑定的**技能**在**流程**里规定的顺序和阶段中执行。

### 7.2 如何与 v1.1 对齐且不锁死板子/牌库

- **v1.1 的「夜晚六步」** 不要写成「只有 12 人标准局、爱神局……」这种按板子名硬编码，而是：
  - **流程 (processes)** 里用 `phase_config` 描述「夜晚」拆成多步，每步写清：
    - 对应哪些 **skill_code**（如 `guard_protect`、`werewolf_kill`、`seer_check`、`witch_save`/`witch_poison` 等）
    - 该步**时长（秒）**、下一步名称等
  - 运行时：根据**当前板子**上的角色 → 其卡牌绑定的技能 → 只执行**本局存在的**且出现在流程中的那些步骤；顺序以流程配置为准。
- **牌库/技能** 若需要「新人也能排进夜晚顺序」：
  - 在 **skills** 表增加可选字段：如 `night_step`（1–6 对应前置/守护/击杀/查验/功能/收尾）、`night_sub_order`、`operation_duration_seconds`，用于：
    - 后台新建技能时指定属于哪一步、默认时长；
    - 当某技能**不在**当前流程的 `phase_config` 里时，引擎可按 `night_step` + `night_sub_order` 插入到对应位置，避免「自定义牌/技能」无法参与夜晚。
  - 流程里已显式列出的 skill_code，以流程中的顺序和时长为准；未列出的用技能表上的 step/order/duration 兜底。

这样：

- **预设板子**：照 v1.1 在流程里配好「守卫→狼人→预言家→女巫→猎人」等顺序与时长即可。
- **自定义板子**：仍可自由选牌、自由组合；夜晚顺序 = 流程里定义的步骤序列 + 本局实际存在的角色对应的技能；新增角色/技能只要在流程中加一步或在技能表里设好 `night_step`，即可融入 v1.1 的六步框架。

### 7.3 建议实现要点（避免冲突）

1. **流程配置**：`phase_config` 支持「夜晚」拆成多子步，每步含 `skill_codes[]` 与 `duration_seconds`；板子仍只选「用哪个流程」，不按板子名写死顺序。
2. **技能表**：可选增加 `night_step`、`night_sub_order`、`operation_duration_seconds`，供未在流程中列出的技能参与夜晚排序与超时。
3. **运行时**：根据**当前局板子 → board_roles → cards → skills** 得到本局技能集合，再按**流程中的夜晚步骤顺序**只执行本局存在的技能步；顺序与时长以流程为主、技能表兜底。
4. **白天流程**：警长竞选、遗言、发言、公投等，可用同一套「流程配置」思路（如 day 的子阶段 + 时长），不依赖具体板子名，只依赖「是否开启警长」等开关（可放在板子或全局配置）。

按上述方式，**v1.1 文档** 只约束「顺序与规则长什么样」，**后台自由配置板子和牌库** 负责「具体有哪些板子、哪些牌、哪套流程」；两者兼容，不冲突。

---

**文档来源**：《狼人杀完整游戏流程文档（含全角色入夜行动顺序）v1.1》  
**维护**：开发时以本文档与 v1.1 PDF 为准，如有冲突以 v1.1 原文为准。
